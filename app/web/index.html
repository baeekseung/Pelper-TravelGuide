<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Travel Guide - Naver Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- 네이버 지도 JS API -->
  <script
    src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId={{ NAVER_MAP_CLIENT_ID }}&submodules=geocoder&callback=initMap">
  </script>

  <!-- 마크다운 / XSS 방지 / 코드 하이라이트 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <style>
    :root {
      --bg: #0b0b0c; --fg:#eaeaea; --border:#222; --card:#111214; --cardBorder:#1e1f22; --muted:#a1a1a1;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--fg); }
    header { padding:12px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:8px;}
    .container {
      display:grid;
      grid-template-columns: 1fr 420px;   /* 기본: 지도 + 사이드바 */
      gap:12px; height: calc(100vh - 57px);
      transition: grid-template-columns .25s ease;
      padding: 0 24px; /* 페이지 좌우 여백 */
    }
    /* === 모드별 레이아웃 === */
    .container.split { grid-template-columns: 1fr 1fr; }      /* 지도 1 : 답변 1 */
    .container.full  { grid-template-columns: 1fr; }           /* 답변 전체 화면 */
    .container.full aside { border-left:none; }
    #map { width:100%; height:100%; }
    aside { padding:12px; border-left:1px solid var(--border); overflow:auto; }
    .card { background: var(--card); border:1px solid var(--cardBorder); border-radius:14px; padding:12px; margin-bottom:12px; }
    label { display:block; font-size:12px; opacity:.85; margin-bottom:6px; }
    input, select, button, textarea {
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a2b2f; background:#0e0f11; color:var(--fg); outline:none;
    }
    button { cursor:pointer; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .srcitem { font-size:13px; margin:6px 0; }
    a { color:#8ab4ff; text-decoration:none; }
    .muted { color:var(--muted); font-size:12px; }
    .hidden { display:none !important; }

    /* 답변 패널 */
    .answer-shell { display:flex; justify-content:center; }
    .answer-panel {
      width: min(960px, 96vw);
      margin: 8px auto 24px;
      padding: 0;
      border-radius: 16px;
      overflow: hidden;
      border:1px solid var(--cardBorder);
      background: var(--card);
      height: calc(100vh - 100px);       /* 분할 보기에서 적절한 높이 */
      display:flex; flex-direction:column;
    }
    .answer-header {
      display:flex; align-items:center; gap:8px; padding:10px 12px; border-bottom:1px solid var(--border); background:#0f1012;
      position: sticky; top: 0; z-index: 2;
    }
    .answer-header button { width:auto; border-radius:8px; padding:8px 10px; }
    .answer-body { padding:14px; overflow:auto; }
    .answer-title { font-weight:700; margin-bottom:6px; }
    .answer-divider { border:none; border-top:1px solid var(--border); margin:12px 0; }
    .source-title { font-weight:600; margin-bottom:6px; }

    /* 모바일 최적화 */
    @media (max-width: 920px) {
      .container { grid-template-columns: 1fr; padding: 0 12px; }
      aside { border-left:none; }
    }

    /* === 분할 보기 개선: 가운데 정렬 + 좌우 여백 + 동일 너비 === */
    .container.split {
      grid-template-columns: 1fr 1fr; /* 지도 1 : 답변 1 */
      column-gap: 24px;               /* 두 칼럼 사이 간격 */
      max-width: 1400px;              /* 전체 최대 폭 제한 */
      margin: 0 auto;                 /* 가운데 정렬 */
    }
    .container.split aside {
      border-left: none;
      padding: 0;
    }
    #map {
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid var(--cardBorder);
      background: var(--card);
    }
    .container.split #answerPanelWrap .answer-panel {
      width: 100%;
      margin: 0;
      height: calc(100vh - 100px);
    }
    .container.full #answerPanelWrap .answer-panel {
      width: min(960px, 96vw);
      margin: 8px auto 24px;
    }

    /* --- Markdown Typography (prose) --- */
    .prose { line-height:1.7; color:var(--fg); }
    .prose h1,.prose h2,.prose h3 { font-weight:800; line-height:1.25; margin:1.2em 0 .4em; }
    .prose h1 { font-size:1.6rem; }
    .prose h2 { font-size:1.35rem; }
    .prose h3 { font-size:1.15rem; }
    .prose p { margin:.8em 0; }
    .prose ul,.prose ol { padding-left:1.3em; margin:.8em 0; }
    .prose li { margin:.25em 0; }
    .prose a { color:#8ab4ff; text-decoration:none; }
    .prose blockquote { margin:1em 0; padding:.6em .9em; border-left:3px solid #334; background:#0d0e10; border-radius:8px; }
    .prose code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#0e0f11; border:1px solid #2a2b2f; padding:2px 6px; border-radius:6px; }
    .prose pre { background:#0e0f11; border:1px solid #2a2b2f; padding:12px; border-radius:12px; overflow:auto; }
    .prose table { width:100%; border-collapse:collapse; margin:1em 0; }
    .prose th,.prose td { border:1px solid #2a2b2f; padding:.6em .7em; text-align:left; }
    .prose thead th { background:#101114; }

    /* 마커 스타일 */
    .marker-info {
      background: var(--card);
      border: 1px solid var(--cardBorder);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 12px;
      max-width: 200px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .marker-info h4 {
      margin: 0 0 4px 0;
      font-size: 13px;
      font-weight: 600;
    }
    .marker-info p {
      margin: 2px 0;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <header>
    <strong>PELPER : Travel Guide Chat Service for MBTI P</strong>
    <!-- 답변 모드에서만 보이는 헤더 버튼들 -->
    <div id="answerHeaderBtns" class="hidden" style="display:flex; gap:8px; flex-wrap:wrap;">
      <button id="btnMapMode"   title="지도+사이드바 모드로 돌아가기">지도 보기</button>
      <button id="btnSplitMode" title="지도와 답변을 좌우로 나란히">분할 보기</button>
      <button id="btnFullMode"  title="답변만 크게 보기">전체 보기</button>
      <button id="newQueryBtn"  title="새 요청하기">새 요청</button>
    </div>
  </header>

  <div class="container" id="layout">
    <!-- 왼쪽: 지도 -->
    <div id="map"></div>

    <!-- 오른쪽: 사이드바(입력/결과 또는 분할/전체의 답변 패널) -->
    <aside id="sidebar">
      <!-- 입력 카드 -->
      <div class="card" id="inputCard">
        <label>여행 요청 (예: "감성 카페 코스 추천")</label>
        <input id="query" placeholder="요청 내용을 입력하세요" />
      </div>

      <!-- 위치 카드 -->
      <div class="card" id="locationCard">
        <div class="row">
          <div>
            <label>선택 좌표(lat)</label>
            <input id="lat" readonly />
          </div>
          <div>
            <label>선택 좌표(lng)</label>
            <input id="lng" readonly />
          </div>
        </div>
        <div style="margin-top:8px;">
          <label>해석된 주소</label>
          <input id="addr" readonly />
        </div>
        <div style="margin-top:10px;">
          <button id="go">가이드 요청</button>
        </div>
        <div class="muted" style="margin-top:6px;">지도를 클릭하면 위치가 선택됩니다.</div>
      </div>

      <!-- 결과(사이드바 모드에서 보이는 작은 결과) -->
      <div class="card" id="result" style="display:none;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
          <div style="font-weight:600;">가이드 응답</div>
          <button id="expandAnswerBtn" style="width:auto; padding:6px 10px; border-radius:8px;">크게 보기</button>
        </div>
        <div id="answer" class="prose"></div>
        <hr class="answer-divider">
        <div style="font-weight:600; margin-bottom:6px;">출처</div>
        <div id="sources"></div>
      </div>

      <!-- 답변 패널(분할/전체 공용) -->
      <div id="answerPanelWrap" class="hidden answer-shell">
        <div class="answer-panel">
          <div class="answer-header">
            <div class="answer-title">가이드 응답</div>
          </div>
          <div class="answer-body">
            <div id="answerFull" class="prose"></div>
            <hr class="answer-divider">
            <div class="source-title">출처</div>
            <div id="sourcesFull"></div>
          </div>
        </div>
      </div>
    </aside>
  </div>

<script>
  let map, marker, selectedLatLng = null, selectedAddr = "";
  let lastData = null;  // 최근 응답 저장
  let placeMarkers = [];  // 장소 마커들
  let infoWindow = null;  // 정보창

  /* ===== 모드 전환 유틸 ===== */
  // 간단한 HTML 이스케이프(마커 라벨 XSS 방지)
  function escapeHtml(str) {
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
    return String(str || "").replace(/[&<>"']/g, ch => map[ch]);
  }
  function toBaseMode() {
    const layout = document.getElementById('layout');
    layout.classList.remove('split', 'full');
    document.getElementById('map').classList.remove('hidden');

    document.getElementById('inputCard').classList.remove('hidden');
    document.getElementById('locationCard').classList.remove('hidden');
    document.getElementById('result').style.display = lastData ? 'block' : 'none';
    document.getElementById('result').classList.remove('hidden');

    document.getElementById('answerPanelWrap').classList.add('hidden');
    document.getElementById('answerHeaderBtns').classList.add('hidden');

    if (lastData) {
      document.getElementById('result').scrollIntoView({ behavior:'smooth', block:'start' });
    }
  }

  function toSplitMode() {
    const layout = document.getElementById('layout');
    layout.classList.add('split');
    layout.classList.remove('full');
    document.getElementById('map').classList.remove('hidden');

    document.getElementById('inputCard').classList.add('hidden');
    document.getElementById('locationCard').classList.add('hidden');
    document.getElementById('result').classList.add('hidden');

    document.getElementById('answerPanelWrap').classList.remove('hidden');
    document.getElementById('answerHeaderBtns').classList.remove('hidden');

    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function toFullMode() {
    const layout = document.getElementById('layout');
    layout.classList.add('full');
    layout.classList.remove('split');
    document.getElementById('map').classList.add('hidden');

    document.getElementById('inputCard').classList.add('hidden');
    document.getElementById('locationCard').classList.add('hidden');
    document.getElementById('result').classList.add('hidden');

    document.getElementById('answerPanelWrap').classList.remove('hidden');
    document.getElementById('answerHeaderBtns').classList.remove('hidden');

    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // 가이드 요청 성공 시 기본으로 "분할 보기"로 진입
  function enterAnswerModeDefault() { toSplitMode(); }

  /* ===== 마커 관련 함수들 ===== */
  function clearPlaceMarkers() {
    placeMarkers.forEach(marker => marker.setMap(null));
    placeMarkers = [];
    if (infoWindow) {
      infoWindow.close();
    }
  }

  function addPlaceMarkers(places) {
    console.log('=== addPlaceMarkers 시작 ===');
    console.log('addPlaceMarkers 호출됨, 장소 개수:', places.length);
    console.log('지도 객체:', map);
    console.log('지도가 null인가?', map === null);
    clearPlaceMarkers();
    
    places.forEach((place, index) => {
      console.log(`--- 장소 ${index + 1} 처리 시작 ---`);
      console.log(`장소 ${index + 1}:`, place);
      
      // WGS84 좌표 유효성 검사
      if (!place.lat || !place.lng || isNaN(place.lat) || isNaN(place.lng)) {
        console.log(`❌ 장소 ${index + 1} 좌표가 유효하지 않음:`, place.lat, place.lng);
        return;
      }
      
      // 좌표 범위 검사 (한국 지역)
      if (place.lat < 33 || place.lat > 38.5 || place.lng < 124 || place.lng > 132) {
        console.log(`❌ 장소 ${index + 1} 좌표가 한국 범위를 벗어남:`, place.lat, place.lng);
        return;
      }
      
      console.log(`✅ 장소 ${index + 1} 좌표 유효성 검사 통과`);
      
      const position = new naver.maps.LatLng(place.lat, place.lng);
      console.log(`장소 ${index + 1} 위치 객체 생성:`, position);
      
      // 장소 마커 생성 (다른 색상 사용)
      console.log(`장소 ${index + 1} 마커 생성 시도...`);
      try {
        const placeMarker = new naver.maps.Marker({
          position: position,
          map: map,
          icon: {
            content: `<div style="background:#ff6b6b; color:#fff; padding:6px 10px; border-radius:14px; font-size:12px; font-weight:600; border:2px solid #fff; box-shadow:0 2px 4px rgba(0,0,0,0.3); white-space:nowrap; transform: translate(-50%, -110%); position: relative; left: 12px; top: 12px;">${escapeHtml(place.title || '장소')}</div>`,
            size: new naver.maps.Size(24, 24),
            anchor: new naver.maps.Point(12, 12)
          }
        });
        
        console.log(`✅ 장소 ${index + 1} 마커 생성 완료:`, placeMarker);
        placeMarkers.push(placeMarker);
        console.log(`장소 ${index + 1} 마커 배열에 추가됨. 현재 마커 개수:`, placeMarkers.length);
      } catch (error) {
        console.log(`❌ 장소 ${index + 1} 마커 생성 실패:`, error);
      }

      console.log(`--- 장소 ${index + 1} 처리 완료 ---`);
    });
    
    console.log(`=== addPlaceMarkers 완료. 총 마커 개수: ${placeMarkers.length} ===`);

    // 모든 마커가 보이도록 지도 범위 조정
    if (places.length > 0) {
      console.log('지도 범위 조정 시작');
      const bounds = new naver.maps.LatLngBounds();
      
      places.forEach(place => {
        if (place.lat && place.lng && !isNaN(place.lat) && !isNaN(place.lng)) {
          bounds.extend(new naver.maps.LatLng(place.lat, place.lng));
          console.log(`범위에 추가: ${place.title} (${place.lat}, ${place.lng})`);
        }
      });
      
      // 사용자 위치도 포함
      if (selectedLatLng) {
        bounds.extend(selectedLatLng);
        console.log('사용자 위치도 범위에 추가');
      }
      
      console.log('지도 범위 조정 실행:', bounds);
      map.fitBounds(bounds);
    }
  }

  async function initMap() {
    // 기본: 서울 시청
    let center = new naver.maps.LatLng(37.5665, 126.9780);

    // 서버에서 현재 위치 시도
    try {
      const response = await fetch('/v1/location/current');
      const locationData = await response.json();
      if (locationData.status === 'success' && locationData.lat && locationData.lng) {
        center = new naver.maps.LatLng(locationData.lat, locationData.lng);
        console.log('앱 시작 시 설정된 현재 위치로 지도 중심 설정:', locationData.lat, locationData.lng);
      } else {
        console.log('현재 위치를 가져올 수 없어 기본 위치를 사용합니다.');
      }
    } catch (error) {
      console.error('현재 위치 가져오기 실패:', error);
    }

    map = new naver.maps.Map('map', {
      center, zoom: 14, mapTypeControl: false, scaleControl: true
    });

    marker = new naver.maps.Marker({ 
      position: center, 
      map, 
      visible: true,
      icon: {
        content: `<div style="background: #4CAF50; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">📍</div>`,
        size: new naver.maps.Size(24, 24),
        anchor: new naver.maps.Point(12, 12)
      }
    });

    // 현재 위치 선택 상태
    selectedLatLng = center;
    document.getElementById('lat').value = center.y.toFixed(6);
    document.getElementById('lng').value = center.x.toFixed(6);

    // 현재 위치 주소 역지오코딩
    try {
      naver.maps.Service.reverseGeocode({
        coords: center,
        orders: [naver.maps.Service.OrderType.ADDR, naver.maps.Service.OrderType.ROAD_ADDR].join(',')
      }, function(status, resp) {
        if (status === naver.maps.Service.Status.OK) {
          const addr = resp.v2.address?.jibunAddress || resp.v2.roadAddress?.address || "";
          selectedAddr = addr;
          document.getElementById('addr').value = addr;
        }
      });
    } catch (err) {
      console.error('주소 가져오기 실패:', err);
    }

    // 지도 클릭으로 위치 선택
    naver.maps.Event.addListener(map, 'click', async function(e) {
      // 분할 보기 모드에서는 사용자 위치 마커 이동을 막는다
      const layoutEl = document.getElementById('layout');
      if (layoutEl && layoutEl.classList.contains('split')) {
        return;
      }
      const latlng = e.coord;
      selectedLatLng = latlng;
      marker.setPosition(latlng);
      marker.setVisible(true);

      document.getElementById('lat').value = latlng.y.toFixed(6);
      document.getElementById('lng').value = latlng.x.toFixed(6);

      // 역지오코딩
      try {
        naver.maps.Service.reverseGeocode({
          coords: latlng,
          orders: [naver.maps.Service.OrderType.ADDR, naver.maps.Service.OrderType.ROAD_ADDR].join(',')
        }, function(status, resp) {
          if (status !== naver.maps.Service.Status.OK) {
            selectedAddr = "";
            document.getElementById('addr').value = "";
            return;
          }
          const addr = resp.v2.address?.jibunAddress || resp.v2.roadAddress?.address || "";
          selectedAddr = addr;
          document.getElementById('addr').value = addr;
        });
      } catch (err) {
        console.error(err);
      }
    });
  }

  // ==== Markdown 렌더러 설정 ====
  marked.setOptions({
    gfm: true,
    breaks: true,
    highlight(code, lang) {
      try {
        if (lang && hljs.getLanguage(lang)) {
          return hljs.highlight(code, { language: lang }).value;
        }
      } catch {}
      return hljs.highlightAuto(code).value;
    }
  });

  function renderMarkdown(mdText) {
    const rawHtml = marked.parse(mdText || "(응답 없음)");
    return DOMPurify.sanitize(rawHtml, { USE_PROFILES: { html: true } });
  }

  function highlightAll(rootEl) {
    rootEl.querySelectorAll('pre code').forEach((el) => {
      try { hljs.highlightElement(el); } catch {}
    });
  }

  function renderResult(data) {
    // (1) 사이드바 모드 콘텐츠
    const resultEl = document.getElementById('result');
    const ansEl = document.getElementById('answer');
    const srcEl = document.getElementById('sources');

    ansEl.innerHTML = renderMarkdown(data.answer);
    highlightAll(ansEl);

    srcEl.innerHTML = "";
    (data.sources || []).forEach(s => {
      const div = document.createElement('div');
      div.className = "srcitem";
      div.innerHTML = `• <a href="${s.url}" target="_blank" rel="noreferrer">${s.title}</a> <span class="muted">(${s.type})</span>`;
      srcEl.appendChild(div);
    });
    resultEl.style.display = "block";

    // (2) 큰 답변 패널(분할/전체 공용)
    const ansFullEl = document.getElementById('answerFull');
    const srcFullEl = document.getElementById('sourcesFull');

    ansFullEl.innerHTML = renderMarkdown(data.answer);
    highlightAll(ansFullEl);

    srcFullEl.innerHTML = "";
    (data.sources || []).forEach(s => {
      const div = document.createElement('div');
      div.className = "srcitem";
      div.innerHTML = `• <a href="${s.url}" target="_blank" rel="noreferrer">${s.title}</a> <span class="muted">(${s.type})</span>`;
      srcFullEl.appendChild(div);
    });

    // 제목 자동 추출(선택)
    const titleMatch = (data.answer || "").match(/^#\s+(.+)$|^##\s+(.+)$/m);
    const title = titleMatch ? (titleMatch[1] || titleMatch[2]) : null;
    const titleEl = document.querySelector('.answer-title');
    titleEl.textContent = title || "가이드 응답";

    // (3) 지도에 마커 표시
    console.log('=== 마커 표시 시작 ===');
    console.log('응답 데이터:', data);
    console.log('장소 정보:', data.places);
    console.log('장소 개수:', data.places ? data.places.length : 0);
    console.log('사용자 위치:', data.center);
    
    // 사용자 위치 마커 표시
    if (data.center) {
      console.log('사용자 위치 마커 생성:', data.center);
      const userPosition = new naver.maps.LatLng(data.center.lat, data.center.lng);
      
      // 기존 사용자 마커 제거
      if (marker) {
        marker.setMap(null);
      }
      
      // 새로운 사용자 마커 생성
      marker = new naver.maps.Marker({
        position: userPosition,
        map: map,
        visible: true,
        icon: {
          content: `<div style="background: #4CAF50; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">📍</div>`,
          size: new naver.maps.Size(24, 24),
          anchor: new naver.maps.Point(12, 12)
        }
      });
      
      // 지도 중심을 사용자 위치로 이동
      map.setCenter(userPosition);
      map.setZoom(15);
    }
    
    if (data.places && data.places.length > 0) {
      console.log('장소 마커 추가 시작');
      addPlaceMarkers(data.places);
    } else {
      console.log('장소 정보가 없습니다');
    }
    console.log('=== 마커 표시 완료 ===');
  }

  async function requestGuide() {
    const query = document.getElementById('query').value.trim();
    const radius = 1500; // 기본값
    const maxResults = 12; // 기본값

    if (!selectedLatLng) { alert("지도를 클릭해 위치를 먼저 선택하세요."); return; }
    if (!query) { alert("요청 내용을 입력하세요."); return; }

    const body = {
      query,
      location_text: selectedAddr || null,
      lat: selectedLatLng.y,
      lng: selectedLatLng.x,
      radius_m: radius,
      language: "ko",
      max_results: maxResults,
      llm_model: "gpt-4o-mini",
      safe_mode: true
    };

    try {
      const res = await fetch("/v1/guide/query", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        const errText = await res.text();
        throw new Error(errText || ("HTTP " + res.status));
      }
      const data = await res.json();
      renderResult(data);
      lastData = data;
      enterAnswerModeDefault(); // 기본: 분할 보기
    } catch (err) {
      console.error(err);
      alert("요청 중 오류가 발생했습니다.\n" + err.message);
    }
  }

  // 이벤트 바인딩
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('go').addEventListener('click', requestGuide);

    // 헤더 모드 전환 버튼
    document.getElementById('btnMapMode').addEventListener('click', toBaseMode);
    document.getElementById('btnSplitMode').addEventListener('click', toSplitMode);
    document.getElementById('btnFullMode').addEventListener('click', toFullMode);

    document.getElementById('newQueryBtn').addEventListener('click', () => {
      toBaseMode();
      document.getElementById('query').focus();
    });

    // 사이드바의 "크게 보기" → 전체 보기로
    document.getElementById('expandAnswerBtn').addEventListener('click', toFullMode);
  });

  // 지도 init
  window.addEventListener('load', initMap);
</script>
</body>
</html>

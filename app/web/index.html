<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Travel Guide - Naver Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- 네이버 지도 JS API (지오코더 서브모듈 포함) -->
  <script
  src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId={{ NAVER_MAP_CLIENT_ID }}&submodules=geocoder&callback=initMap">
</script>
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: #0b0b0c; color: #eaeaea; }
    header { padding: 12px 16px; border-bottom: 1px solid #222; }
    .container { display: grid; grid-template-columns: 1fr 420px; gap: 12px; height: calc(100vh - 57px); }
    #map { width: 100%; height: 100%; }
    aside { padding: 12px; border-left: 1px solid #222; overflow: auto; }
    .card { background: #111214; border: 1px solid #1e1f22; border-radius: 14px; padding: 12px; margin-bottom: 12px; }
    label { display:block; font-size: 12px; opacity:.85; margin-bottom: 6px; }
    input, select, button, textarea {
      width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #2a2b2f;
      background: #0e0f11; color: #eaeaea; outline: none;
    }
    button { cursor: pointer; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .srcitem { font-size: 13px; margin: 6px 0; }
    a { color: #8ab4ff; text-decoration: none; }
    .muted { color: #a1a1a1; font-size: 12px; }
  </style>
</head>
<body>
  <header>
    <strong>P 백승주들을 위한 여행 가이드</strong>
  </header>
  <div class="container">
    <div id="map"></div>
    <aside>
      <div class="card">
        <label>여행 요청 (예: "감성 카페 코스 추천")</label>
        <input id="query" placeholder="요청 내용을 입력하세요" />
        <div class="row" style="margin-top:8px;">
          <div>
            <label>반경(m)</label>
            <input id="radius" type="number" value="1500" min="100" step="100" />
          </div>
          <div>
            <label>결과 개수</label>
            <select id="maxResults">
              <option>8</option><option selected>12</option><option>16</option><option>20</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <div>
            <label>선택 좌표(lat)</label>
            <input id="lat" readonly />
          </div>
          <div>
            <label>선택 좌표(lng)</label>
            <input id="lng" readonly />
          </div>
        </div>
        <div style="margin-top:8px;">
          <label>해석된 주소</label>
          <input id="addr" readonly />
        </div>
        <div style="margin-top:10px;">
          <button id="go">가이드 요청</button>
        </div>
        <div class="muted" style="margin-top:6px;">지도를 클릭하면 위치가 선택됩니다.</div>
      </div>

      <div class="card" id="result" style="display:none;">
        <div style="font-weight:600; margin-bottom:6px;">가이드 응답</div>
        <div id="answer" style="white-space:pre-wrap;"></div>
        <hr style="border:none;border-top:1px solid #222; margin:12px 0;">
        <div style="font-weight:600; margin-bottom:6px;">출처</div>
        <div id="sources"></div>
      </div>
    </aside>
  </div>

<script>
  let map, marker, selectedLatLng = null, selectedAddr = "";

  function initMap() {
    const center = new naver.maps.LatLng(37.5665, 126.9780); // 서울 시청 근처 기본값
    map = new naver.maps.Map('map', {
      center, zoom: 14, mapTypeControl: false, scaleControl: true
    });

    marker = new naver.maps.Marker({ position: center, map, visible: false });

    naver.maps.Event.addListener(map, 'click', async function(e) {
      const latlng = e.coord;
      selectedLatLng = latlng;
      marker.setPosition(latlng);
      marker.setVisible(true);

      document.getElementById('lat').value = latlng.y.toFixed(6);
      document.getElementById('lng').value = latlng.x.toFixed(6);

      // 리버스 지오코딩 (주소)
      try {
        naver.maps.Service.reverseGeocode({
          coords: latlng,
          orders: [naver.maps.Service.OrderType.ADDR, naver.maps.Service.OrderType.ROAD_ADDR].join(',')
        }, function(status, resp) {
          if (status !== naver.maps.Service.Status.OK) {
            selectedAddr = "";
            document.getElementById('addr').value = "";
            return;
          }
          const addr = resp.v2.address?.jibunAddress || resp.v2.roadAddress?.address || "";
          selectedAddr = addr;
          document.getElementById('addr').value = addr;
        });
      } catch (err) {
        console.error(err);
      }
    });
  }

  async function requestGuide() {
    const query = document.getElementById('query').value.trim();
    const radius = parseInt(document.getElementById('radius').value || "1500", 10);
    const maxResults = parseInt(document.getElementById('maxResults').value || "12", 10);

    if (!selectedLatLng) {
      alert("지도를 클릭해 위치를 먼저 선택하세요.");
      return;
    }
    if (!query) {
      alert("요청 내용을 입력하세요.");
      return;
    }

    const body = {
      query,
      location_text: selectedAddr || null,
      lat: selectedLatLng.y,
      lng: selectedLatLng.x,
      radius_m: radius,
      language: "ko",
      max_results: maxResults,
      llm_model: "gpt-4o-mini",
      safe_mode: true
    };

    try {
      const res = await fetch("/v1/guide/query", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        const errText = await res.text();
        throw new Error(errText || ("HTTP " + res.status));
      }
      const data = await res.json();
      renderResult(data);
    } catch (err) {
      console.error(err);
      alert("요청 중 오류가 발생했습니다.\n" + err.message);
    }
  }

  function renderResult(data) {
    const resultEl = document.getElementById('result');
    const ansEl = document.getElementById('answer');
    const srcEl = document.getElementById('sources');

    ansEl.textContent = data.answer || "(응답 없음)";

    srcEl.innerHTML = "";
    (data.sources || []).forEach(s => {
      const div = document.createElement('div');
      div.className = "srcitem";
      div.innerHTML = `• <a href="${s.url}" target="_blank" rel="noreferrer">${s.title}</a> <span class="muted">(${s.type})</span>`;
      srcEl.appendChild(div);
    });

    resultEl.style.display = "block";
  }

  document.getElementById('go').addEventListener('click', requestGuide);

  // 지도 init
  window.addEventListener('load', initMap);
</script>
</body>
</html>

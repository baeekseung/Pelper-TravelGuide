<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Travel Guide - Naver Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ë„¤ì´ë²„ ì§€ë„ JS API -->
  <script
    src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId={{ NAVER_MAP_CLIENT_ID }}&submodules=geocoder&callback=initMap">
  </script>

  <!-- ë§ˆí¬ë‹¤ìš´ / XSS ë°©ì§€ / ì½”ë“œ í•˜ì´ë¼ì´íŠ¸ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <style>
    :root {
      --bg: #0b0b0c; --fg:#eaeaea; --border:#222; --card:#111214; --cardBorder:#1e1f22; --muted:#a1a1a1;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--fg); }
    header { padding:12px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:8px;}
    .container {
      display:grid;
      grid-template-columns: 1fr 420px;   /* ê¸°ë³¸: ì§€ë„ + ì‚¬ì´ë“œë°” */
      gap:12px; height: calc(100vh - 57px);
      transition: grid-template-columns .25s ease;
      padding: 0 24px; /* í˜ì´ì§€ ì¢Œìš° ì—¬ë°± */
    }
    /* === ëª¨ë“œë³„ ë ˆì´ì•„ì›ƒ === */
    .container.split { grid-template-columns: 1fr 1fr; }      /* ì§€ë„ 1 : ë‹µë³€ 1 */
    .container.full  { grid-template-columns: 1fr; }           /* ë‹µë³€ ì „ì²´ í™”ë©´ */
    .container.full aside { border-left:none; }
    #map { width:100%; height:100%; }
    aside { padding:12px; border-left:1px solid var(--border); overflow:auto; }
    .card { background: var(--card); border:1px solid var(--cardBorder); border-radius:14px; padding:12px; margin-bottom:12px; }
    label { display:block; font-size:12px; opacity:.85; margin-bottom:6px; }
    input, select, button, textarea {
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a2b2f; background:#0e0f11; color:var(--fg); outline:none;
    }
    button { cursor:pointer; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .srcitem { font-size:13px; margin:6px 0; }
    a { color:#8ab4ff; text-decoration:none; }
    .muted { color:var(--muted); font-size:12px; }
    .hidden { display:none !important; }

    /* ë‹µë³€ íŒ¨ë„ */
    .answer-shell { display:flex; justify-content:center; }
    .answer-panel {
      width: min(960px, 96vw);
      margin: 8px auto 24px;
      padding: 0;
      border-radius: 16px;
      overflow: hidden;
      border:1px solid var(--cardBorder);
      background: var(--card);
      height: calc(100vh - 100px);       /* ë¶„í•  ë³´ê¸°ì—ì„œ ì ì ˆí•œ ë†’ì´ */
      display:flex; flex-direction:column;
    }
    .answer-header {
      display:flex; align-items:center; gap:8px; padding:10px 12px; border-bottom:1px solid var(--border); background:#0f1012;
      position: sticky; top: 0; z-index: 2;
    }
    .answer-header button { width:auto; border-radius:8px; padding:8px 10px; }
    .answer-body { padding:14px; overflow:auto; }
    .answer-title { font-weight:700; margin-bottom:6px; }
    .answer-divider { border:none; border-top:1px solid var(--border); margin:12px 0; }
    .source-title { font-weight:600; margin-bottom:6px; }

    /* ëª¨ë°”ì¼ ìµœì í™” */
    @media (max-width: 920px) {
      .container { grid-template-columns: 1fr; padding: 0 12px; }
      aside { border-left:none; }
    }

    /* === ë¶„í•  ë³´ê¸° ê°œì„ : ê°€ìš´ë° ì •ë ¬ + ì¢Œìš° ì—¬ë°± + ë™ì¼ ë„ˆë¹„ === */
    .container.split {
      grid-template-columns: 1fr 1fr; /* ì§€ë„ 1 : ë‹µë³€ 1 */
      column-gap: 24px;               /* ë‘ ì¹¼ëŸ¼ ì‚¬ì´ ê°„ê²© */
      max-width: 1400px;              /* ì „ì²´ ìµœëŒ€ í­ ì œí•œ */
      margin: 0 auto;                 /* ê°€ìš´ë° ì •ë ¬ */
    }
    .container.split aside {
      border-left: none;
      padding: 0;
    }
    #map {
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid var(--cardBorder);
      background: var(--card);
    }
    .container.split #answerPanelWrap .answer-panel {
      width: 100%;
      margin: 0;
      height: calc(100vh - 100px);
    }
    .container.full #answerPanelWrap .answer-panel {
      width: min(960px, 96vw);
      margin: 8px auto 24px;
    }

    /* --- Markdown Typography (prose) --- */
    .prose { line-height:1.7; color:var(--fg); }
    .prose h1,.prose h2,.prose h3 { font-weight:800; line-height:1.25; margin:1.2em 0 .4em; }
    .prose h1 { font-size:1.6rem; }
    .prose h2 { font-size:1.35rem; }
    .prose h3 { font-size:1.15rem; }
    .prose p { margin:.8em 0; }
    .prose ul,.prose ol { padding-left:1.3em; margin:.8em 0; }
    .prose li { margin:.25em 0; }
    .prose a { color:#8ab4ff; text-decoration:none; }
    .prose blockquote { margin:1em 0; padding:.6em .9em; border-left:3px solid #334; background:#0d0e10; border-radius:8px; }
    .prose code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#0e0f11; border:1px solid #2a2b2f; padding:2px 6px; border-radius:6px; }
    .prose pre { background:#0e0f11; border:1px solid #2a2b2f; padding:12px; border-radius:12px; overflow:auto; }
    .prose table { width:100%; border-collapse:collapse; margin:1em 0; }
    .prose th,.prose td { border:1px solid #2a2b2f; padding:.6em .7em; text-align:left; }
    .prose thead th { background:#101114; }

    /* ë§ˆì»¤ ìŠ¤íƒ€ì¼ */
    .marker-info {
      background: var(--card);
      border: 1px solid var(--cardBorder);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 12px;
      max-width: 200px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .marker-info h4 {
      margin: 0 0 4px 0;
      font-size: 13px;
      font-weight: 600;
    }
    .marker-info p {
      margin: 2px 0;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <header>
    <strong>PELPER : Travel Guide Chat Service for MBTI P</strong>
    <!-- ë‹µë³€ ëª¨ë“œì—ì„œë§Œ ë³´ì´ëŠ” í—¤ë” ë²„íŠ¼ë“¤ -->
    <div id="answerHeaderBtns" class="hidden" style="display:flex; gap:8px; flex-wrap:wrap;">
      <button id="btnMapMode"   title="ì§€ë„+ì‚¬ì´ë“œë°” ëª¨ë“œë¡œ ëŒì•„ê°€ê¸°">ì§€ë„ ë³´ê¸°</button>
      <button id="btnSplitMode" title="ì§€ë„ì™€ ë‹µë³€ì„ ì¢Œìš°ë¡œ ë‚˜ë€íˆ">ë¶„í•  ë³´ê¸°</button>
      <button id="btnFullMode"  title="ë‹µë³€ë§Œ í¬ê²Œ ë³´ê¸°">ì „ì²´ ë³´ê¸°</button>
      <button id="newQueryBtn"  title="ìƒˆ ìš”ì²­í•˜ê¸°">ìƒˆ ìš”ì²­</button>
    </div>
  </header>

  <div class="container" id="layout">
    <!-- ì™¼ìª½: ì§€ë„ -->
    <div id="map"></div>

    <!-- ì˜¤ë¥¸ìª½: ì‚¬ì´ë“œë°”(ì…ë ¥/ê²°ê³¼ ë˜ëŠ” ë¶„í• /ì „ì²´ì˜ ë‹µë³€ íŒ¨ë„) -->
    <aside id="sidebar">
      <!-- ì…ë ¥ ì¹´ë“œ -->
      <div class="card" id="inputCard">
        <label>ì—¬í–‰ ìš”ì²­ (ì˜ˆ: "ê°ì„± ì¹´í˜ ì½”ìŠ¤ ì¶”ì²œ")</label>
        <input id="query" placeholder="ìš”ì²­ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" />
      </div>

      <!-- ìœ„ì¹˜ ì¹´ë“œ -->
      <div class="card" id="locationCard">
        <div class="row">
          <div>
            <label>ì„ íƒ ì¢Œí‘œ(lat)</label>
            <input id="lat" readonly />
          </div>
          <div>
            <label>ì„ íƒ ì¢Œí‘œ(lng)</label>
            <input id="lng" readonly />
          </div>
        </div>
        <div style="margin-top:8px;">
          <label>í•´ì„ëœ ì£¼ì†Œ</label>
          <input id="addr" readonly />
        </div>
        <div style="margin-top:10px;">
          <button id="go">ê°€ì´ë“œ ìš”ì²­</button>
        </div>
        <div class="muted" style="margin-top:6px;">ì§€ë„ë¥¼ í´ë¦­í•˜ë©´ ìœ„ì¹˜ê°€ ì„ íƒë©ë‹ˆë‹¤.</div>
      </div>

      <!-- ê²°ê³¼(ì‚¬ì´ë“œë°” ëª¨ë“œì—ì„œ ë³´ì´ëŠ” ì‘ì€ ê²°ê³¼) -->
      <div class="card" id="result" style="display:none;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
          <div style="font-weight:600;">ê°€ì´ë“œ ì‘ë‹µ</div>
          <button id="expandAnswerBtn" style="width:auto; padding:6px 10px; border-radius:8px;">í¬ê²Œ ë³´ê¸°</button>
        </div>
        <div id="answer" class="prose"></div>
        <hr class="answer-divider">
        <div style="font-weight:600; margin-bottom:6px;">ì¶œì²˜</div>
        <div id="sources"></div>
      </div>

      <!-- ë‹µë³€ íŒ¨ë„(ë¶„í• /ì „ì²´ ê³µìš©) -->
      <div id="answerPanelWrap" class="hidden answer-shell">
        <div class="answer-panel">
          <div class="answer-header">
            <div class="answer-title">ê°€ì´ë“œ ì‘ë‹µ</div>
          </div>
          <div class="answer-body">
            <div id="answerFull" class="prose"></div>
            <hr class="answer-divider">
            <div class="source-title">ì¶œì²˜</div>
            <div id="sourcesFull"></div>
          </div>
        </div>
      </div>
    </aside>
  </div>

<script>
  let map, marker, selectedLatLng = null, selectedAddr = "";
  let lastData = null;  // ìµœê·¼ ì‘ë‹µ ì €ì¥
  let placeMarkers = [];  // ì¥ì†Œ ë§ˆì»¤ë“¤
  let infoWindow = null;  // ì •ë³´ì°½

  /* ===== ëª¨ë“œ ì „í™˜ ìœ í‹¸ ===== */
  // ê°„ë‹¨í•œ HTML ì´ìŠ¤ì¼€ì´í”„(ë§ˆì»¤ ë¼ë²¨ XSS ë°©ì§€)
  function escapeHtml(str) {
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
    return String(str || "").replace(/[&<>"']/g, ch => map[ch]);
  }
  function toBaseMode() {
    const layout = document.getElementById('layout');
    layout.classList.remove('split', 'full');
    document.getElementById('map').classList.remove('hidden');

    document.getElementById('inputCard').classList.remove('hidden');
    document.getElementById('locationCard').classList.remove('hidden');
    document.getElementById('result').style.display = lastData ? 'block' : 'none';
    document.getElementById('result').classList.remove('hidden');

    document.getElementById('answerPanelWrap').classList.add('hidden');
    document.getElementById('answerHeaderBtns').classList.add('hidden');

    if (lastData) {
      document.getElementById('result').scrollIntoView({ behavior:'smooth', block:'start' });
    }
  }

  function toSplitMode() {
    const layout = document.getElementById('layout');
    layout.classList.add('split');
    layout.classList.remove('full');
    document.getElementById('map').classList.remove('hidden');

    document.getElementById('inputCard').classList.add('hidden');
    document.getElementById('locationCard').classList.add('hidden');
    document.getElementById('result').classList.add('hidden');

    document.getElementById('answerPanelWrap').classList.remove('hidden');
    document.getElementById('answerHeaderBtns').classList.remove('hidden');

    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function toFullMode() {
    const layout = document.getElementById('layout');
    layout.classList.add('full');
    layout.classList.remove('split');
    document.getElementById('map').classList.add('hidden');

    document.getElementById('inputCard').classList.add('hidden');
    document.getElementById('locationCard').classList.add('hidden');
    document.getElementById('result').classList.add('hidden');

    document.getElementById('answerPanelWrap').classList.remove('hidden');
    document.getElementById('answerHeaderBtns').classList.remove('hidden');

    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // ê°€ì´ë“œ ìš”ì²­ ì„±ê³µ ì‹œ ê¸°ë³¸ìœ¼ë¡œ "ë¶„í•  ë³´ê¸°"ë¡œ ì§„ì…
  function enterAnswerModeDefault() { toSplitMode(); }

  /* ===== ë§ˆì»¤ ê´€ë ¨ í•¨ìˆ˜ë“¤ ===== */
  function clearPlaceMarkers() {
    placeMarkers.forEach(marker => marker.setMap(null));
    placeMarkers = [];
    if (infoWindow) {
      infoWindow.close();
    }
  }

  function addPlaceMarkers(places) {
    console.log('=== addPlaceMarkers ì‹œì‘ ===');
    console.log('addPlaceMarkers í˜¸ì¶œë¨, ì¥ì†Œ ê°œìˆ˜:', places.length);
    console.log('ì§€ë„ ê°ì²´:', map);
    console.log('ì§€ë„ê°€ nullì¸ê°€?', map === null);
    clearPlaceMarkers();
    
    places.forEach((place, index) => {
      console.log(`--- ì¥ì†Œ ${index + 1} ì²˜ë¦¬ ì‹œì‘ ---`);
      console.log(`ì¥ì†Œ ${index + 1}:`, place);
      
      // WGS84 ì¢Œí‘œ ìœ íš¨ì„± ê²€ì‚¬
      if (!place.lat || !place.lng || isNaN(place.lat) || isNaN(place.lng)) {
        console.log(`âŒ ì¥ì†Œ ${index + 1} ì¢Œí‘œê°€ ìœ íš¨í•˜ì§€ ì•ŠìŒ:`, place.lat, place.lng);
        return;
      }
      
      // ì¢Œí‘œ ë²”ìœ„ ê²€ì‚¬ (í•œêµ­ ì§€ì—­)
      if (place.lat < 33 || place.lat > 38.5 || place.lng < 124 || place.lng > 132) {
        console.log(`âŒ ì¥ì†Œ ${index + 1} ì¢Œí‘œê°€ í•œêµ­ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¨:`, place.lat, place.lng);
        return;
      }
      
      console.log(`âœ… ì¥ì†Œ ${index + 1} ì¢Œí‘œ ìœ íš¨ì„± ê²€ì‚¬ í†µê³¼`);
      
      const position = new naver.maps.LatLng(place.lat, place.lng);
      console.log(`ì¥ì†Œ ${index + 1} ìœ„ì¹˜ ê°ì²´ ìƒì„±:`, position);
      
      // ì¥ì†Œ ë§ˆì»¤ ìƒì„± (ë‹¤ë¥¸ ìƒ‰ìƒ ì‚¬ìš©)
      console.log(`ì¥ì†Œ ${index + 1} ë§ˆì»¤ ìƒì„± ì‹œë„...`);
      try {
        const placeMarker = new naver.maps.Marker({
          position: position,
          map: map,
          icon: {
            content: `<div style="background:#ff6b6b; color:#fff; padding:6px 10px; border-radius:14px; font-size:12px; font-weight:600; border:2px solid #fff; box-shadow:0 2px 4px rgba(0,0,0,0.3); white-space:nowrap; transform: translate(-50%, -110%); position: relative; left: 12px; top: 12px;">${escapeHtml(place.title || 'ì¥ì†Œ')}</div>`,
            size: new naver.maps.Size(24, 24),
            anchor: new naver.maps.Point(12, 12)
          }
        });
        
        console.log(`âœ… ì¥ì†Œ ${index + 1} ë§ˆì»¤ ìƒì„± ì™„ë£Œ:`, placeMarker);
        placeMarkers.push(placeMarker);
        console.log(`ì¥ì†Œ ${index + 1} ë§ˆì»¤ ë°°ì—´ì— ì¶”ê°€ë¨. í˜„ì¬ ë§ˆì»¤ ê°œìˆ˜:`, placeMarkers.length);
      } catch (error) {
        console.log(`âŒ ì¥ì†Œ ${index + 1} ë§ˆì»¤ ìƒì„± ì‹¤íŒ¨:`, error);
      }

      console.log(`--- ì¥ì†Œ ${index + 1} ì²˜ë¦¬ ì™„ë£Œ ---`);
    });
    
    console.log(`=== addPlaceMarkers ì™„ë£Œ. ì´ ë§ˆì»¤ ê°œìˆ˜: ${placeMarkers.length} ===`);

    // ëª¨ë“  ë§ˆì»¤ê°€ ë³´ì´ë„ë¡ ì§€ë„ ë²”ìœ„ ì¡°ì •
    if (places.length > 0) {
      console.log('ì§€ë„ ë²”ìœ„ ì¡°ì • ì‹œì‘');
      const bounds = new naver.maps.LatLngBounds();
      
      places.forEach(place => {
        if (place.lat && place.lng && !isNaN(place.lat) && !isNaN(place.lng)) {
          bounds.extend(new naver.maps.LatLng(place.lat, place.lng));
          console.log(`ë²”ìœ„ì— ì¶”ê°€: ${place.title} (${place.lat}, ${place.lng})`);
        }
      });
      
      // ì‚¬ìš©ì ìœ„ì¹˜ë„ í¬í•¨
      if (selectedLatLng) {
        bounds.extend(selectedLatLng);
        console.log('ì‚¬ìš©ì ìœ„ì¹˜ë„ ë²”ìœ„ì— ì¶”ê°€');
      }
      
      console.log('ì§€ë„ ë²”ìœ„ ì¡°ì • ì‹¤í–‰:', bounds);
      map.fitBounds(bounds);
    }
  }

  async function initMap() {
    // ê¸°ë³¸: ì„œìš¸ ì‹œì²­
    let center = new naver.maps.LatLng(37.5665, 126.9780);

    // ì„œë²„ì—ì„œ í˜„ì¬ ìœ„ì¹˜ ì‹œë„
    try {
      const response = await fetch('/v1/location/current');
      const locationData = await response.json();
      if (locationData.status === 'success' && locationData.lat && locationData.lng) {
        center = new naver.maps.LatLng(locationData.lat, locationData.lng);
        console.log('ì•± ì‹œì‘ ì‹œ ì„¤ì •ëœ í˜„ì¬ ìœ„ì¹˜ë¡œ ì§€ë„ ì¤‘ì‹¬ ì„¤ì •:', locationData.lat, locationData.lng);
      } else {
        console.log('í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ ê¸°ë³¸ ìœ„ì¹˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.');
      }
    } catch (error) {
      console.error('í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
    }

    map = new naver.maps.Map('map', {
      center, zoom: 14, mapTypeControl: false, scaleControl: true
    });

    marker = new naver.maps.Marker({ 
      position: center, 
      map, 
      visible: true,
      icon: {
        content: `<div style="background: #4CAF50; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">ğŸ“</div>`,
        size: new naver.maps.Size(24, 24),
        anchor: new naver.maps.Point(12, 12)
      }
    });

    // í˜„ì¬ ìœ„ì¹˜ ì„ íƒ ìƒíƒœ
    selectedLatLng = center;
    document.getElementById('lat').value = center.y.toFixed(6);
    document.getElementById('lng').value = center.x.toFixed(6);

    // í˜„ì¬ ìœ„ì¹˜ ì£¼ì†Œ ì—­ì§€ì˜¤ì½”ë”©
    try {
      naver.maps.Service.reverseGeocode({
        coords: center,
        orders: [naver.maps.Service.OrderType.ADDR, naver.maps.Service.OrderType.ROAD_ADDR].join(',')
      }, function(status, resp) {
        if (status === naver.maps.Service.Status.OK) {
          const addr = resp.v2.address?.jibunAddress || resp.v2.roadAddress?.address || "";
          selectedAddr = addr;
          document.getElementById('addr').value = addr;
        }
      });
    } catch (err) {
      console.error('ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', err);
    }

    // ì§€ë„ í´ë¦­ìœ¼ë¡œ ìœ„ì¹˜ ì„ íƒ
    naver.maps.Event.addListener(map, 'click', async function(e) {
      // ë¶„í•  ë³´ê¸° ëª¨ë“œì—ì„œëŠ” ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤ ì´ë™ì„ ë§‰ëŠ”ë‹¤
      const layoutEl = document.getElementById('layout');
      if (layoutEl && layoutEl.classList.contains('split')) {
        return;
      }
      const latlng = e.coord;
      selectedLatLng = latlng;
      marker.setPosition(latlng);
      marker.setVisible(true);

      document.getElementById('lat').value = latlng.y.toFixed(6);
      document.getElementById('lng').value = latlng.x.toFixed(6);

      // ì—­ì§€ì˜¤ì½”ë”©
      try {
        naver.maps.Service.reverseGeocode({
          coords: latlng,
          orders: [naver.maps.Service.OrderType.ADDR, naver.maps.Service.OrderType.ROAD_ADDR].join(',')
        }, function(status, resp) {
          if (status !== naver.maps.Service.Status.OK) {
            selectedAddr = "";
            document.getElementById('addr').value = "";
            return;
          }
          const addr = resp.v2.address?.jibunAddress || resp.v2.roadAddress?.address || "";
          selectedAddr = addr;
          document.getElementById('addr').value = addr;
        });
      } catch (err) {
        console.error(err);
      }
    });
  }

  // ==== Markdown ë Œë”ëŸ¬ ì„¤ì • ====
  marked.setOptions({
    gfm: true,
    breaks: true,
    highlight(code, lang) {
      try {
        if (lang && hljs.getLanguage(lang)) {
          return hljs.highlight(code, { language: lang }).value;
        }
      } catch {}
      return hljs.highlightAuto(code).value;
    }
  });

  function renderMarkdown(mdText) {
    const rawHtml = marked.parse(mdText || "(ì‘ë‹µ ì—†ìŒ)");
    return DOMPurify.sanitize(rawHtml, { USE_PROFILES: { html: true } });
  }

  function highlightAll(rootEl) {
    rootEl.querySelectorAll('pre code').forEach((el) => {
      try { hljs.highlightElement(el); } catch {}
    });
  }

  function renderResult(data) {
    // (1) ì‚¬ì´ë“œë°” ëª¨ë“œ ì½˜í…ì¸ 
    const resultEl = document.getElementById('result');
    const ansEl = document.getElementById('answer');
    const srcEl = document.getElementById('sources');

    ansEl.innerHTML = renderMarkdown(data.answer);
    highlightAll(ansEl);

    srcEl.innerHTML = "";
    (data.sources || []).forEach(s => {
      const div = document.createElement('div');
      div.className = "srcitem";
      div.innerHTML = `â€¢ <a href="${s.url}" target="_blank" rel="noreferrer">${s.title}</a> <span class="muted">(${s.type})</span>`;
      srcEl.appendChild(div);
    });
    resultEl.style.display = "block";

    // (2) í° ë‹µë³€ íŒ¨ë„(ë¶„í• /ì „ì²´ ê³µìš©)
    const ansFullEl = document.getElementById('answerFull');
    const srcFullEl = document.getElementById('sourcesFull');

    ansFullEl.innerHTML = renderMarkdown(data.answer);
    highlightAll(ansFullEl);

    srcFullEl.innerHTML = "";
    (data.sources || []).forEach(s => {
      const div = document.createElement('div');
      div.className = "srcitem";
      div.innerHTML = `â€¢ <a href="${s.url}" target="_blank" rel="noreferrer">${s.title}</a> <span class="muted">(${s.type})</span>`;
      srcFullEl.appendChild(div);
    });

    // ì œëª© ìë™ ì¶”ì¶œ(ì„ íƒ)
    const titleMatch = (data.answer || "").match(/^#\s+(.+)$|^##\s+(.+)$/m);
    const title = titleMatch ? (titleMatch[1] || titleMatch[2]) : null;
    const titleEl = document.querySelector('.answer-title');
    titleEl.textContent = title || "ê°€ì´ë“œ ì‘ë‹µ";

    // (3) ì§€ë„ì— ë§ˆì»¤ í‘œì‹œ
    console.log('=== ë§ˆì»¤ í‘œì‹œ ì‹œì‘ ===');
    console.log('ì‘ë‹µ ë°ì´í„°:', data);
    console.log('ì¥ì†Œ ì •ë³´:', data.places);
    console.log('ì¥ì†Œ ê°œìˆ˜:', data.places ? data.places.length : 0);
    console.log('ì‚¬ìš©ì ìœ„ì¹˜:', data.center);
    
    // ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤ í‘œì‹œ
    if (data.center) {
      console.log('ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤ ìƒì„±:', data.center);
      const userPosition = new naver.maps.LatLng(data.center.lat, data.center.lng);
      
      // ê¸°ì¡´ ì‚¬ìš©ì ë§ˆì»¤ ì œê±°
      if (marker) {
        marker.setMap(null);
      }
      
      // ìƒˆë¡œìš´ ì‚¬ìš©ì ë§ˆì»¤ ìƒì„±
      marker = new naver.maps.Marker({
        position: userPosition,
        map: map,
        visible: true,
        icon: {
          content: `<div style="background: #4CAF50; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">ğŸ“</div>`,
          size: new naver.maps.Size(24, 24),
          anchor: new naver.maps.Point(12, 12)
        }
      });
      
      // ì§€ë„ ì¤‘ì‹¬ì„ ì‚¬ìš©ì ìœ„ì¹˜ë¡œ ì´ë™
      map.setCenter(userPosition);
      map.setZoom(15);
    }
    
    if (data.places && data.places.length > 0) {
      console.log('ì¥ì†Œ ë§ˆì»¤ ì¶”ê°€ ì‹œì‘');
      addPlaceMarkers(data.places);
    } else {
      console.log('ì¥ì†Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤');
    }
    console.log('=== ë§ˆì»¤ í‘œì‹œ ì™„ë£Œ ===');
  }

  async function requestGuide() {
    const query = document.getElementById('query').value.trim();
    const radius = 1500; // ê¸°ë³¸ê°’
    const maxResults = 12; // ê¸°ë³¸ê°’

    if (!selectedLatLng) { alert("ì§€ë„ë¥¼ í´ë¦­í•´ ìœ„ì¹˜ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”."); return; }
    if (!query) { alert("ìš”ì²­ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }

    const body = {
      query,
      location_text: selectedAddr || null,
      lat: selectedLatLng.y,
      lng: selectedLatLng.x,
      radius_m: radius,
      language: "ko",
      max_results: maxResults,
      llm_model: "gpt-4o-mini",
      safe_mode: true
    };

    try {
      const res = await fetch("/v1/guide/query", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        const errText = await res.text();
        throw new Error(errText || ("HTTP " + res.status));
      }
      const data = await res.json();
      renderResult(data);
      lastData = data;
      enterAnswerModeDefault(); // ê¸°ë³¸: ë¶„í•  ë³´ê¸°
    } catch (err) {
      console.error(err);
      alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n" + err.message);
    }
  }

  // ì´ë²¤íŠ¸ ë°”ì¸ë”©
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('go').addEventListener('click', requestGuide);

    // í—¤ë” ëª¨ë“œ ì „í™˜ ë²„íŠ¼
    document.getElementById('btnMapMode').addEventListener('click', toBaseMode);
    document.getElementById('btnSplitMode').addEventListener('click', toSplitMode);
    document.getElementById('btnFullMode').addEventListener('click', toFullMode);

    document.getElementById('newQueryBtn').addEventListener('click', () => {
      toBaseMode();
      document.getElementById('query').focus();
    });

    // ì‚¬ì´ë“œë°”ì˜ "í¬ê²Œ ë³´ê¸°" â†’ ì „ì²´ ë³´ê¸°ë¡œ
    document.getElementById('expandAnswerBtn').addEventListener('click', toFullMode);
  });

  // ì§€ë„ init
  window.addEventListener('load', initMap);
</script>
</body>
</html>
